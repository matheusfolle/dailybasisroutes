<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - DailyBasisRoute</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>ğŸ¯ DailyBasisRoute</h1>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/analytics" class="active">Analytics</a>
                <a href="/historico">HistÃ³rico</a>
                <a href="/logout">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>ğŸ“Š Analytics & Insights</h2>
        
        <!-- GrÃ¡fico Semanal -->
        <div class="chart-container">
            <h3>ğŸ“ˆ Progresso Semanal (Ãšltimos 7 dias)</h3>
            <canvas id="weekChart"></canvas>
        </div>

        <!-- GrÃ¡fico Mensal -->
        <div class="chart-container">
            <h3>ğŸ“… Progresso Mensal (Ãšltimos 30 dias)</h3>
            <canvas id="monthChart"></canvas>
        </div>

        <!-- MOOD ANALYTICS -->
        <h2 style="margin-top: 40px;">ğŸ˜Š AnÃ¡lise de Humor</h2>

        <!-- Heatmap de Humor -->
        <div class="chart-container">
            <h3>ğŸŒ¡ï¸ Heatmap de Humor (Ãšltimos 30 dias)</h3>
            <div id="moodHeatmap" class="mood-heatmap"></div>
        </div>

        <!-- GrÃ¡fico de Humor ao Longo do Tempo -->
        <div class="chart-container">
            <h3>ğŸ“ˆ EvoluÃ§Ã£o do Humor</h3>
            <canvas id="moodChart"></canvas>
        </div>

        <!-- GrÃ¡fico de CorrelaÃ§Ã£o Pontos vs Humor -->
        <div class="chart-container">
            <h3>ğŸ”— CorrelaÃ§Ã£o: Produtividade vs Humor</h3>
            <canvas id="correlationChart"></canvas>
            <p id="correlationText" style="text-align: center; margin-top: 10px; font-weight: 500;"></p>
        </div>

        <!-- Stats de Humor -->
        <div class="stats-summary">
            <h3>ğŸ˜Š EstatÃ­sticas de Humor</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="avgMood">--</div>
                    <div class="stat-label">Humor MÃ©dio</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestMood">--</div>
                    <div class="stat-label">Melhor Dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="worstMood">--</div>
                    <div class="stat-label">Pior Dia</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="moodTrend">--</div>
                    <div class="stat-label">TendÃªncia</div>
                </div>
            </div>
        </div>

        <!-- Stats Resumidos -->
        <div class="stats-summary">
            <h3>ğŸ“‹ Resumo de Produtividade</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="weekAvg">0</div>
                    <div class="stat-label">MÃ©dia Semanal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monthAvg">0</div>
                    <div class="stat-label">MÃ©dia Mensal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">Taxa de Sucesso (60+)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestDay">0</div>
                    <div class="stat-label">Melhor Dia</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadAnalytics() {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            // Processar dados semanais
            const weekDates = [];
            const weekPoints = [];
            const last7Days = getLast7Days();
            
            last7Days.forEach(date => {
                const found = data.week.find(d => d.date === date);
                weekDates.push(formatDate(date));
                weekPoints.push(found ? found.points : 0);
            });
            
            // Processar dados mensais
            const monthDates = [];
            const monthPoints = [];
            const last30Days = getLast30Days();
            
            last30Days.forEach(date => {
                const found = data.month.find(d => d.date === date);
                monthDates.push(formatDate(date));
                monthPoints.push(found ? found.points : 0);
            });
            
            // Criar grÃ¡fico semanal
            new Chart(document.getElementById('weekChart'), {
                type: 'line',
                data: {
                    labels: weekDates,
                    datasets: [{
                        label: 'Pontos',
                        data: weekPoints,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + ' pts';
                                }
                            }
                        }
                    }
                }
            });
            
            // Criar grÃ¡fico mensal
            new Chart(document.getElementById('monthChart'), {
                type: 'bar',
                data: {
                    labels: monthDates,
                    datasets: [{
                        label: 'Pontos',
                        data: monthPoints,
                        backgroundColor: monthPoints.map(p => 
                            p >= 60 ? '#667eea' : p >= 40 ? '#f093fb' : '#f5576c'
                        ),
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + ' pts';
                                }
                            }
                        }
                    }
                }
            });
            
            // Calcular estatÃ­sticas
            const weekAvg = weekPoints.reduce((a, b) => a + b, 0) / weekPoints.filter(p => p > 0).length || 0;
            const monthAvg = monthPoints.reduce((a, b) => a + b, 0) / monthPoints.filter(p => p > 0).length || 0;
            const successCount = monthPoints.filter(p => p >= 60).length;
            const successRate = (successCount / monthPoints.filter(p => p > 0).length * 100) || 0;
            const bestDay = Math.max(...monthPoints);
            
            document.getElementById('weekAvg').textContent = Math.round(weekAvg);
            document.getElementById('monthAvg').textContent = Math.round(monthAvg);
            document.getElementById('successRate').textContent = Math.round(successRate) + '%';
            document.getElementById('bestDay').textContent = bestDay;
            
            // ========== MOOD ANALYTICS ==========
            
            if (data.mood && data.mood.length > 0) {
                // Criar heatmap de humor
                createMoodHeatmap(data.mood);
                
                // GrÃ¡fico de evoluÃ§Ã£o do humor
                createMoodChart(data.mood);
                
                // GrÃ¡fico de correlaÃ§Ã£o
                createCorrelationChart(data.month, data.mood);
                
                // EstatÃ­sticas de humor
                const moodValues = data.mood.map(m => m.mood);
                const avgMood = moodValues.reduce((a, b) => a + b, 0) / moodValues.length;
                const bestMood = Math.max(...moodValues);
                const worstMood = Math.min(...moodValues);
                
                // Calcular tendÃªncia (Ãºltimos 7 dias vs 7 anteriores)
                const recent7 = moodValues.slice(-7);
                const previous7 = moodValues.slice(-14, -7);
                const recentAvg = recent7.reduce((a, b) => a + b, 0) / recent7.length || 0;
                const previousAvg = previous7.reduce((a, b) => a + b, 0) / previous7.length || 0;
                const trend = recentAvg - previousAvg;
                
                document.getElementById('avgMood').textContent = Math.round(avgMood);
                document.getElementById('bestMood').textContent = bestMood;
                document.getElementById('worstMood').textContent = worstMood;
                document.getElementById('moodTrend').textContent = trend > 0 ? `ğŸ“ˆ +${Math.round(trend)}` : trend < 0 ? `ğŸ“‰ ${Math.round(trend)}` : 'â¡ï¸ 0';
            }
        }
        
        function createMoodHeatmap(moodData) {
            const container = document.getElementById('moodHeatmap');
            container.innerHTML = '';
            
            // Ãšltimos 30 dias
            const last30 = getLast30Days();
            
            last30.forEach(date => {
                const moodEntry = moodData.find(m => m.date === date);
                const mood = moodEntry ? moodEntry.mood : null;
                
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.title = `${formatDate(date)}: ${mood !== null ? mood : 'Sem registro'}`;
                
                if (mood === null) {
                    cell.style.background = '#eee';
                } else if (mood >= 80) {
                    cell.style.background = '#00d084';
                } else if (mood >= 60) {
                    cell.style.background = '#667eea';
                } else if (mood >= 40) {
                    cell.style.background = '#f093fb';
                } else {
                    cell.style.background = '#f5576c';
                }
                
                container.appendChild(cell);
            });
        }
        
        function createMoodChart(moodData) {
            const last30 = getLast30Days();
            const moodDates = [];
            const moodValues = [];
            
            last30.forEach(date => {
                const found = moodData.find(m => m.date === date);
                moodDates.push(formatDate(date));
                moodValues.push(found ? found.mood : null);
            });
            
            new Chart(document.getElementById('moodChart'), {
                type: 'line',
                data: {
                    labels: moodDates,
                    datasets: [{
                        label: 'Humor',
                        data: moodValues,
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        tension: 0.4,
                        fill: true,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createCorrelationChart(pointsData, moodData) {
            // Combinar pontos e mood por data
            const combined = [];
            pointsData.forEach(p => {
                const moodEntry = moodData.find(m => m.date === p.date);
                if (moodEntry) {
                    combined.push({
                        x: p.points,
                        y: moodEntry.mood
                    });
                }
            });
            
            new Chart(document.getElementById('correlationChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Pontos vs Humor',
                        data: combined,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: '#667eea',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Pontos'
                            },
                            beginAtZero: true,
                            max: 100
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Humor'
                            },
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Calcular correlaÃ§Ã£o simples
            if (combined.length > 1) {
                const correlation = calculateCorrelation(combined);
                const corrText = document.getElementById('correlationText');
                
                if (correlation > 0.7) {
                    corrText.textContent = `ğŸ”¥ Forte correlaÃ§Ã£o positiva (${(correlation * 100).toFixed(0)}%): Mais pontos = Melhor humor!`;
                    corrText.style.color = '#00d084';
                } else if (correlation > 0.4) {
                    corrText.textContent = `âœ… CorrelaÃ§Ã£o moderada (${(correlation * 100).toFixed(0)}%): Produtividade ajuda no humor.`;
                    corrText.style.color = '#667eea';
                } else if (correlation > 0) {
                    corrText.textContent = `â¡ï¸ CorrelaÃ§Ã£o fraca (${(correlation * 100).toFixed(0)}%): HÃ¡ alguma relaÃ§Ã£o.`;
                    corrText.style.color = '#999';
                } else {
                    corrText.textContent = `âŒ Sem correlaÃ§Ã£o clara: Humor independe dos pontos.`;
                    corrText.style.color = '#f5576c';
                }
            }
        }
        
        function calculateCorrelation(data) {
            const n = data.length;
            const sumX = data.reduce((sum, p) => sum + p.x, 0);
            const sumY = data.reduce((sum, p) => sum + p.y, 0);
            const sumXY = data.reduce((sum, p) => sum + p.x * p.y, 0);
            const sumX2 = data.reduce((sum, p) => sum + p.x * p.x, 0);
            const sumY2 = data.reduce((sum, p) => sum + p.y * p.y, 0);
            
            const numerator = (n * sumXY) - (sumX * sumY);
            const denominator = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }
        
        function getLast7Days() {
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function getLast30Days() {
            const dates = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
        }
        
        loadAnalytics();
    </script>
</body>
</html>
