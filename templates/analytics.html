<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - DailyBasisRoute</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>ðŸŽ¯ DailyBasisRoute</h1>
            <div class="nav-links">
                <a href="/dashboard">Dashboard</a>
                <a href="/analytics" class="active">Analytics</a>
                <a href="/historico">HistÃ³rico</a>
                <a href="/logout">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>ðŸ“Š Analytics & Insights</h2>
        
        <!-- GrÃ¡fico Semanal -->
        <div class="chart-container">
            <h3>ðŸ“ˆ Progresso Semanal (Ãšltimos 7 dias)</h3>
            <canvas id="weekChart"></canvas>
        </div>

        <!-- GrÃ¡fico Mensal -->
        <div class="chart-container">
            <h3>ðŸ“… Progresso Mensal (Ãšltimos 30 dias)</h3>
            <canvas id="monthChart"></canvas>
        </div>

        <!-- Stats Resumidos -->
        <div class="stats-summary">
            <h3>ðŸ“‹ Resumo</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="weekAvg">0</div>
                    <div class="stat-label">MÃ©dia Semanal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="monthAvg">0</div>
                    <div class="stat-label">MÃ©dia Mensal</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">Taxa de Sucesso (60+)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bestDay">0</div>
                    <div class="stat-label">Melhor Dia</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadAnalytics() {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            // Processar dados semanais
            const weekDates = [];
            const weekPoints = [];
            const last7Days = getLast7Days();
            
            last7Days.forEach(date => {
                const found = data.week.find(d => d.date === date);
                weekDates.push(formatDate(date));
                weekPoints.push(found ? found.points : 0);
            });
            
            // Processar dados mensais
            const monthDates = [];
            const monthPoints = [];
            const last30Days = getLast30Days();
            
            last30Days.forEach(date => {
                const found = data.month.find(d => d.date === date);
                monthDates.push(formatDate(date));
                monthPoints.push(found ? found.points : 0);
            });
            
            // Criar grÃ¡fico semanal
            new Chart(document.getElementById('weekChart'), {
                type: 'line',
                data: {
                    labels: weekDates,
                    datasets: [{
                        label: 'Pontos',
                        data: weekPoints,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + ' pts';
                                }
                            }
                        }
                    }
                }
            });
            
            // Criar grÃ¡fico mensal
            new Chart(document.getElementById('monthChart'), {
                type: 'bar',
                data: {
                    labels: monthDates,
                    datasets: [{
                        label: 'Pontos',
                        data: monthPoints,
                        backgroundColor: monthPoints.map(p => 
                            p >= 60 ? '#667eea' : p >= 40 ? '#f093fb' : '#f5576c'
                        ),
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + ' pts';
                                }
                            }
                        }
                    }
                }
            });
            
            // Calcular estatÃ­sticas
            const weekAvg = weekPoints.reduce((a, b) => a + b, 0) / weekPoints.filter(p => p > 0).length || 0;
            const monthAvg = monthPoints.reduce((a, b) => a + b, 0) / monthPoints.filter(p => p > 0).length || 0;
            const successCount = monthPoints.filter(p => p >= 60).length;
            const successRate = (successCount / monthPoints.filter(p => p > 0).length * 100) || 0;
            const bestDay = Math.max(...monthPoints);
            
            document.getElementById('weekAvg').textContent = Math.round(weekAvg);
            document.getElementById('monthAvg').textContent = Math.round(monthAvg);
            document.getElementById('successRate').textContent = Math.round(successRate) + '%';
            document.getElementById('bestDay').textContent = bestDay;
        }
        
        function getLast7Days() {
            const dates = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function getLast30Days() {
            const dates = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);
            }
            return dates;
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
        }
        
        loadAnalytics();
    </script>
</body>
</html>
